var Q=Object.defineProperty;var ee=(a,e,t)=>e in a?Q(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var b=(a,e,t)=>ee(a,typeof e!="symbol"?e+"":e,t);import{b as o,E as te,m as L,c as v,d as R,e as C,n as m,f as x,g as d,h as H,j as K,u as _,w as j,k as $,l as U,o as N,p as O,q as P,S as se,r as M,s as f,t as w,v as Z,U as W,A as q,x as J,y as G,z as D,B as ne,C as ie,F as ae,G as re}from"./index-DGeqQweJ.js";import{l as X,c as V,a as oe,b as ce,d as le,e as ue}from"./index-BFP3ZjEM.js";function pe(a){return/https?:\/\/(?:www\.)?([-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b)*(\/[\/\d\w\.-]*)*(?:[\?])*(.+)*/gi.test(a)}class F{constructor(e,t,s,n,i,r,c,p,l,u,S,g,y,A,E){this.analyticsService=e,this.accessService=t,this.appService=s,this.notificationService=n,this.i18nService=i,this.globalStateService=r,this.apiFreeService=c,this.apiPremiumService=p,this.userService=l,this.webrtcService=u,this.exclusionsService=S,this.abTestsService=g,this.eventService=y,this.proxyService=A,this.connectionService=E}async uninstallSelf(){return await Promise.resolve(this),await o.management.uninstallSelf(),{success:!0,data:{success:!0}}}async refreshSelf(){await this.proxyService.disable();const e=this.eventService.dispatch({reset:void 0});return await Promise.all(e),o.runtime.reload(),{success:!0,data:{success:!0}}}async getAnalyticPrivacy(){return await Promise.resolve(),{success:!0,data:{show:this.analyticsService.needPrivacyAcceptance}}}async setAnalyticPrivacy(e){return await this.analyticsService.setPrivacy(e),await this.accessService.setUninstallURL(),(await o.tabs.query({})).filter(n=>{var i;return(i=n.url)==null?void 0:i.includes("src/pages/consent-settings/index.html")}).forEach(n=>{n!=null&&n.id&&o.tabs.remove(n.id).catch(()=>{})}),await this.accessService.proceedToWebsitePage({page:"install",params:{utm_campaign:"welcome"}}),{success:!0,data:{success:!0}}}async sendAnalyticEvent(e){return await Promise.resolve(),this.analyticsService.sendEvent(e),{success:!0,data:{success:!0}}}async showWebsitePage(e){return await this.accessService.proceedToWebsitePage(e),{success:!0,data:{success:!0}}}async setColorTheme(e){return await this.appService.setColorTheme(e),{success:!0,data:{success:!0}}}async getAppData(){return await Promise.resolve(),{success:!0,data:{version:this.appService.version,theme:this.appService.colorTheme}}}async getShowOnboarding(){return await Promise.resolve(),{success:!0,data:{show:this.appService.showOnboarding}}}async closeOnboarding(){return await this.appService.setShowOnboarding(!1),{success:!0,data:{success:!0}}}async setActiveLocale(e){return await this.i18nService.setLocale(e),{success:!0,data:{success:!0}}}async getActiveLocale(){return await Promise.resolve(),{success:!0,data:{locale:this.i18nService.activeLocale}}}async getLanguageList(){return await Promise.resolve(),{success:!0,data:{list:this.i18nService.languageList}}}async getNotificationPermition(){return await Promise.resolve(),{success:!0,data:{permition:this.notificationService.permition}}}async setNotificationPermition(e){return await this.notificationService.setNotificationPermition(e),{success:!0,data:{success:!0}}}async getSessionCount(){return await Promise.resolve(),{success:!0,data:{count:this.appService.sessionCount}}}async incrementSessionCount(){return await this.appService.incrementSessionCount(),{success:!0,data:{count:this.appService.sessionCount}}}async getDownloadLink(e){return{success:!0,data:{link:await this.appService.getDownloadLink(e)}}}async getBlockAds(){return await Promise.resolve(),{success:!0,data:{status:this.appService.isBlockAds}}}async setBlockAds(e){return await this.appService.setBlockAds(e.status),{success:!0,data:{success:!0}}}async setDeviceScreenData(e){return await this.globalStateService.setDeviceScreenData(e),{success:!0,data:{success:!0}}}async getRateUsData(){return await Promise.resolve(),{success:!0,data:this.appService.rateUsData}}async incrementRateUsData(){return await this.appService.incrementRateUs(),{success:!0,data:{success:!0}}}async showExtensionStore(){const t={platform:"chrome"},s=this.userService.hasPermitions("domain","premium")?await this.apiPremiumService.fetch({method:"POST",url:"apiUrlReview",body:t}):await this.apiFreeService.fetch({method:"POST",url:"apiUrlReview",body:t}),n=s.success?s.data.url:this.appService.extensionStoreUrl;return await o.tabs.create({url:n}),{success:!0,data:{success:!0}}}async getBlockWebrtc(){return await Promise.resolve(),{success:!0,data:{status:this.webrtcService.isApplied}}}async enableBlockWebrtc(){const e=await this.webrtcService.enable();return e.status?(await this.webrtcService.setBlockWebrtc(!0),{success:!0,data:{success:!0}}):{success:!1,errors:[{code:0,status:0,name:"",message:e.cause==="not_controllable"?this.i18nService.t("base:webrtc-errors.not-controllable"):this.i18nService.t("base:webrtc-errors.controlled-by-other-extensions")}]}}async disableBlockWebrtc(){return await this.webrtcService.disable()?(await this.webrtcService.setBlockWebrtc(!1),{success:!0,data:{success:!0}}):{success:!1,errors:[{code:0,status:0,name:"",message:this.i18nService.t("base:webrtc-errors.remove-webrtc")}]}}async getActiveTabInfo(){await Promise.resolve(this);const t=(await o.tabs.query({currentWindow:!0,active:!0})).at(0);if(!t||!t.url)return{success:!0,data:{info:null}};if(!pe(t.url))return{success:!0,data:{info:null}};const{hostname:n}=new URL(t.url);return{success:!0,data:{info:{matchPattern:n,favicon:t.favIconUrl}}}}async getExclusionSites(){return await Promise.resolve(),{success:!0,data:{list:this.exclusionsService.exclusionSites}}}async addExclusionSite(e){return await this.exclusionsService.add(e),{success:!0,data:{success:!0}}}async removeExclusionSite(e){return await this.exclusionsService.remove(e),{success:!0,data:{success:!0}}}async closeConnectionSurvey(){return await this.appService.closeConnectionSurvey(),{success:!0,data:{success:!0}}}async incrementConnectionSurvey(){return await this.appService.incrementConnectionSurvey(),{success:!0,data:{success:!0}}}async delayConnectionSurvey(){return await this.appService.delayConnectionSurvey(),{success:!0,data:{success:!0}}}async disableConnectionSurvey(){return await this.appService.disableConnectionSurvey(),{success:!0,data:{success:!0}}}async getConnectionSurvey(){return await Promise.resolve(),{success:!0,data:{close:this.appService.connectionSurveyClose,needShow:this.appService.needShowConnectionSurvey}}}async getDiscountBanner(){return await Promise.resolve(),{success:!0,data:{active:this.abTestsService.getExperimentStatus(te.discount60off).active}}}async getBanner2Session(){await Promise.resolve();const{banner2Session:e,sessionCount:t}=this.appService,s=e.active&&t>2;if(s){const n=await this.getBanner3Connection();n.success&&n.data.active&&await this.disableBanner3Connection();const i=await this.getBanner15Connection();i.success&&i.data.active&&await this.disableBanner15Connection()}return{success:!0,data:{active:s}}}async disableBanner2Session(){return await this.appService.disableBanner2Session(),{success:!0,data:{success:!0}}}async getBanner3Connection(){await Promise.resolve();const{banner3Connection:e}=this.appService,s=this.connectionService.connectionCount===3;return{success:!0,data:{active:e.active&&s}}}async disableBanner3Connection(){return await this.appService.disableBanner3Connection(),{success:!0,data:{success:!0}}}async getBanner15Connection(){await Promise.resolve();const{banner15Connection:e}=this.appService,s=this.connectionService.connectionCount===15;return{success:!0,data:{active:e.active&&s}}}async disableBanner15Connection(){return await this.appService.disableBanner15Connection(),{success:!0,data:{success:!0}}}async getBanner14Days(){await Promise.resolve(),this.appService.banner14Days.nextTimestamp<Date.now()&&await this.appService.activateBanner14Days();const{banner14Days:t}=this.appService,s=t.active;if(s){const n=await this.getBanner2Session();n.success&&n.data.active&&await this.disableBanner2Session();const i=await this.getBanner3Connection();i.success&&i.data.active&&await this.disableBanner3Connection();const r=await this.getBanner15Connection();r.success&&r.data.active&&await this.disableBanner15Connection()}return{success:!0,data:{active:s}}}async disableBanner14Days(){return await this.appService.disableBanner14Days(),{success:!0,data:{success:!0}}}async getBanner16Days(){var r;await Promise.resolve();const e=(r=this.appService.geolocation)==null?void 0:r.country,t=e!=="ir"&&e!=="ru",{banner16Days:s}=this.appService,n=s.nextTimestamp<Date.now(),i=t&&s.active&&n;if(i){const c=await this.getBanner2Session();c.success&&c.data.active&&await this.disableBanner2Session();const p=await this.getBanner3Connection();p.success&&p.data.active&&await this.disableBanner3Connection();const l=await this.getBanner15Connection();l.success&&l.data.active&&await this.disableBanner15Connection();const u=await this.getBanner14Days();u.success&&u.data.active&&await this.disableBanner14Days()}return{success:!0,data:{active:i}}}async disableBanner16Days(){return await this.appService.disableBanner16Days(),{success:!0,data:{success:!0}}}static async getActiveExtensionsWithProxyPermition(){return(await o.management.getAll()).filter(n=>n.type==="extension"&&n.id!==o.runtime.id).filter(n=>{var c;const i=n.enabled,r=(c=n.permissions)==null?void 0:c.includes("proxy");return i&&r})}async getProxyControlStatus(){const e=await o.tabs.query({active:!0,currentWindow:!0}).then(i=>{var r;return(r=i.at(0))==null?void 0:r.url}),s=["chrome://extensions","about:addons","edge://extensions","opera://extensions"].some(i=>e==null?void 0:e.includes(i));return{success:!0,data:{blocked:!(await this.proxyService.getControlProxyStatus()).status,"extensions-tab":s}}}async openExtensionsTab(){await Promise.resolve(this);const s={chrome:"chrome://extensions",firefox:"about:addons",edge:"edge://extensions",opera:"opera://extensions"}["chrome"];return await o.tabs.create({url:s}),{success:!0,data:{success:!0}}}async disableProxyControlExtensions(){await Promise.resolve(this);const e=await F.getActiveExtensionsWithProxyPermition();return await Promise.all(e.map(t=>o.management.setEnabled(t.id,!1))),{success:!0,data:{success:!0}}}}class he{constructor(e,t){this.messageService=e,this.appController=t}init(){this.messageService.subscribe({"uninstall-self":this.uninstallSelf.bind(this),"refresh-self":this.refreshSelf.bind(this),"hold-active-ping":this.holdActivePing.bind(this),"send-analytic-event":this.sendAnalyticEvent.bind(this),"get-analytic-privacy":this.getAnalyticPrivacy.bind(this),"set-analytic-privacy":this.setAnalyticPrivacy.bind(this),"show-website-page":this.showWebsitePage.bind(this),"set-color-theme":this.setColorTheme.bind(this),"get-app-data":this.getAppData.bind(this),"get-show-onboarding":this.getShowOnboarding.bind(this),"close-onboarding":this.closeOnboarding.bind(this),"set-active-locale":this.setActiveLocale.bind(this),"get-active-locale":this.getActiveLocale.bind(this),"get-language-list":this.getLanguageList.bind(this),"set-notification-permition":this.setNotificationPermition.bind(this),"get-notification-permition":this.getNotificationPermition.bind(this),"get-session-count":this.getSessionCount.bind(this),"increment-session-count":this.incrementSessionCount.bind(this),"get-download-link":this.getDownloadLink.bind(this),"get-block-ads":this.getBlockAds.bind(this),"set-block-ads":this.setBlockAds.bind(this),"set-device-screen":this.setDeviceScreenData.bind(this),"get-rate-us":this.getRateUsData.bind(this),"increment-rate-us":this.incrementRateUsData.bind(this),"show-extension-store":this.showExtensionStore.bind(this),"get-block-webrtc":this.getBlockWebrtc.bind(this),"enable-block-webrtc":this.enableBlockWebrtc.bind(this),"disable-block-webrtc":this.disableBlockWebrtc.bind(this),"get-active-tab-info":this.getActiveTabInfo.bind(this),"get-exclusion-sites":this.getExclusionSites.bind(this),"add-exclusion-site":this.addExclusionSite.bind(this),"remove-exclusion-site":this.removeExclusionSite.bind(this),"close-connection-survey":this.closeConnectionSurvey.bind(this),"increment-connection-survey":this.incrementConnectionSurvey.bind(this),"delay-connection-survey":this.delayConnectionSurvey.bind(this),"disable-connection-survey":this.disableConnectionSurvey.bind(this),"get-connection-survey":this.getConnectionSurvey.bind(this),"get-discount-banner-state":this.getDiscountBanner.bind(this),"get-banner-2-session":this.getBanner2Session.bind(this),"disable-banner-2-session":this.disableBanner2Session.bind(this),"get-banner-3-connection":this.getBanner3Connection.bind(this),"disable-banner-3-connection":this.disableBanner3Connection.bind(this),"get-banner-15-connection":this.getBanner15Connection.bind(this),"disable-banner-15-connection":this.disableBanner15Connection.bind(this),"get-banner-14-days":this.getBanner14Days.bind(this),"disable-banner-14-days":this.disableBanner14Days.bind(this),"get-banner-16-days":this.getBanner16Days.bind(this),"disable-banner-16-days":this.disableBanner16Days.bind(this),"get-proxy-control-status":this.getProxyControlStatus.bind(this),"open-extensions-tab":this.openExtensionsTab.bind(this),"disable-proxy-control-extensions":this.disableProxyControlExtensions.bind(this)})}async uninstallSelf(){return{...await this.appController.uninstallSelf(),type:"uninstall-self"}}async refreshSelf(){return{...await this.appController.refreshSelf(),type:"refresh-self"}}async holdActivePing(){return await Promise.resolve(this),{type:"hold-active-ping",success:!0,data:{success:!0}}}async setAnalyticPrivacy(e){return{...await this.appController.setAnalyticPrivacy(e),type:"set-analytic-privacy"}}async getAnalyticPrivacy(){return{...await this.appController.getAnalyticPrivacy(),type:"get-analytic-privacy"}}async sendAnalyticEvent(e){return{...await this.appController.sendAnalyticEvent(e),type:"send-analytic-event"}}async showWebsitePage(e){return{...await this.appController.showWebsitePage(e),type:"show-website-page"}}async setColorTheme(e){return{...await this.appController.setColorTheme(e),type:"set-color-theme"}}async getAppData(){return{...await this.appController.getAppData(),type:"get-app-data"}}async getShowOnboarding(){return{...await this.appController.getShowOnboarding(),type:"get-show-onboarding"}}async closeOnboarding(){return{...await this.appController.closeOnboarding(),type:"close-onboarding"}}async setActiveLocale(e){return{...await this.appController.setActiveLocale(e),type:"set-active-locale"}}async getActiveLocale(){return{...await this.appController.getActiveLocale(),type:"get-active-locale"}}async getLanguageList(){return{...await this.appController.getLanguageList(),type:"get-language-list"}}async setNotificationPermition(e){return{...await this.appController.setNotificationPermition(e),type:"set-notification-permition"}}async getNotificationPermition(){return{...await this.appController.getNotificationPermition(),type:"get-notification-permition"}}async getSessionCount(){return{...await this.appController.getSessionCount(),type:"get-session-count"}}async incrementSessionCount(){return{...await this.appController.incrementSessionCount(),type:"increment-session-count"}}async getDownloadLink(e){return{...await this.appController.getDownloadLink(e),type:"get-download-link"}}async getBlockAds(){return{...await this.appController.getBlockAds(),type:"get-block-ads"}}async setBlockAds(e){return{...await this.appController.setBlockAds(e),type:"set-block-ads"}}async setDeviceScreenData(e){return{...await this.appController.setDeviceScreenData(e),type:"set-device-screen"}}async getRateUsData(){return{...await this.appController.getRateUsData(),type:"get-rate-us"}}async incrementRateUsData(){return{...await this.appController.incrementRateUsData(),type:"increment-rate-us"}}async showExtensionStore(){return{...await this.appController.showExtensionStore(),type:"show-extension-store"}}async getBlockWebrtc(){return{...await this.appController.getBlockWebrtc(),type:"get-block-webrtc"}}async enableBlockWebrtc(){return{...await this.appController.enableBlockWebrtc(),type:"enable-block-webrtc"}}async disableBlockWebrtc(){return{...await this.appController.disableBlockWebrtc(),type:"disable-block-webrtc"}}async getActiveTabInfo(){return{...await this.appController.getActiveTabInfo(),type:"get-active-tab-info"}}async getExclusionSites(){return{...await this.appController.getExclusionSites(),type:"get-exclusion-sites"}}async addExclusionSite(e){return{...await this.appController.addExclusionSite(e),type:"add-exclusion-site"}}async removeExclusionSite(e){return{...await this.appController.removeExclusionSite(e),type:"remove-exclusion-site"}}async closeConnectionSurvey(){return{...await this.appController.closeConnectionSurvey(),type:"close-connection-survey"}}async incrementConnectionSurvey(){return{...await this.appController.incrementConnectionSurvey(),type:"increment-connection-survey"}}async delayConnectionSurvey(){return{...await this.appController.delayConnectionSurvey(),type:"delay-connection-survey"}}async disableConnectionSurvey(){return{...await this.appController.disableConnectionSurvey(),type:"disable-connection-survey"}}async getConnectionSurvey(){return{...await this.appController.getConnectionSurvey(),type:"get-connection-survey"}}async getDiscountBanner(){return{...await this.appController.getDiscountBanner(),type:"get-discount-banner-state"}}async getBanner2Session(){return{...await this.appController.getBanner2Session(),type:"get-banner-2-session"}}async disableBanner2Session(){return{...await this.appController.disableBanner2Session(),type:"disable-banner-2-session"}}async getBanner3Connection(){return{...await this.appController.getBanner3Connection(),type:"get-banner-3-connection"}}async disableBanner3Connection(){return{...await this.appController.disableBanner3Connection(),type:"disable-banner-3-connection"}}async getBanner15Connection(){return{...await this.appController.getBanner15Connection(),type:"get-banner-15-connection"}}async disableBanner15Connection(){return{...await this.appController.disableBanner15Connection(),type:"disable-banner-15-connection"}}async getBanner14Days(){return{...await this.appController.getBanner14Days(),type:"get-banner-14-days"}}async disableBanner14Days(){return{...await this.appController.disableBanner14Days(),type:"disable-banner-14-days"}}async getBanner16Days(){return{...await this.appController.getBanner16Days(),type:"get-banner-16-days"}}async disableBanner16Days(){return{...await this.appController.disableBanner16Days(),type:"disable-banner-16-days"}}async getProxyControlStatus(){return{...await this.appController.getProxyControlStatus(),type:"get-proxy-control-status"}}async openExtensionsTab(){return{...await this.appController.openExtensionsTab(),type:"open-extensions-tab"}}async disableProxyControlExtensions(){return{...await this.appController.disableProxyControlExtensions(),type:"disable-proxy-control-extensions"}}}const de=new F(v,R,C,m,x,d,H,K,_,j,$,U,N,O,P),ve=new he(L,de);function Se(a){return typeof a=="object"&&a!==null&&"type"in a&&typeof a.type=="string"}class ge extends se{constructor(){super();b(this,"messageMap",new Map);b(this,"edpPort",null);o.runtime.onConnectExternal.addListener(this.longLivedMessageHandler.bind(this))}async boot(){this.bootResolve(),await this.bootPromise}longLivedMessageHandler(t){this.edpPort=t,t.onMessage.addListener(s=>{if(Se(s)){const n=this.messageMap.get(s.type);n&&this.bootPromise.then(()=>n(s.data)).then(i=>{t.postMessage({id:s.id,...i})}).catch(()=>{})}}),t.onDisconnect.addListener(()=>{this.edpPort=null})}subscribe(t){Object.entries(t).forEach(([n,i])=>{if(this.messageMap.has(n))throw Error(`MessageService: subscribe already has ${n} handler`);this.messageMap.set(n,i)})}notifyEdp(t){var s;try{(s=this.edpPort)==null||s.postMessage(t)}catch{}}}const I=new ge,ye=M({sessionId:f().optional().describe(w.session)}).default({}),be=new Z(ye),we="https://www.google-analytics.com/mp/collect",me="G-JY9WLXGNHW",_e="cECyLU2hSiaL1TVJULha8Q",B=W(navigator.userAgent);class fe extends q{constructor(t,s,n,i,r,c,p,l,u,S,g){super(t);b(this,"GA_URL");this.analyticsStorage=s,this.analyticsService=n,this.globalStateService=i,this.fetchService=r,this.userService=c,this.appService=p,this.notificationService=l,this.i18nService=u,this.connectionService=S,this.edpMessageService=g;const y=new URL(we);y.searchParams.set("measurement_id",me),y.searchParams.set("api_secret",_e),this.GA_URL=y.href,this.analyticsService.use(this)}async boot(){await this.analyticsStorage.sync(),this.analyticsStorage.state.sessionId||await this.updateSessionId(),this.bootResolve()}async send(t){if(await this.bootPromise,!this.available)return;const s=this.formatData(t);this.edpMessageService.notifyEdp({type:"edp-ga-analytic-event",success:!0,data:s}),await this.fetchService.request({url:this.GA_URL,method:"POST",body:s})}formatData(t){const s=this.globalStateService.udid.value,n=this.getUserProperties(),i={name:t.name,params:{session_id:this.analyticsStorage.state.sessionId??"",screen_name:"main",engagement_time_msec:100,...t.data??{}}};return{client_id:s,user_properties:n,events:[i]}}getUserProperties(){var l,u;const t=o.runtime.getManifest(),s=this.globalStateService.udid.value,n=((l=this.appService.geolocation)==null?void 0:l.country)??"n/a",i=((u=this.userService.subscription)==null?void 0:u.name)??"free",r=this.notificationService.permition==="allowed"?"on":"off",c=()=>this.appService.colorTheme==="dark"?"on":this.appService.colorTheme==="light"?"off":"default";return{user_type:{value:this.userService.userType},plan:{value:i},udid:{value:s},version:{value:t.version},platform:{value:"chrome_extension"},user_country:{value:n},desktop_notifications:{value:r},dark_mode:{value:c()},language:{value:this.i18nService.activeLocale},auto_connect:{value:this.connectionService.useAutoConnect},browser:{value:B.browser.name??"n/a"},browser_version:{value:B.browser.version??"n/a"},os:{value:B.os.name??"n/a"},os_version:{value:B.os.version??"n/a"}}}async updateSessionId(){await this.analyticsStorage.setItems({sessionId:crypto.randomUUID()})}}const Ce=new J("google-analytics",be,N),h=new fe("google-analytics",Ce,v,d,G,_,C,m,x,P,I),xe="https://cloudflare.com/cdn-cgi/trace",Pe="https://oovttlsctrmbll4c3pxzbi55na0vbuln.lambda-url.us-west-2.on.aws/",ke=10,Ae=M({id:f(),startedAt:D()}),Ee=ne(f(),ie([f(),D(),ae()])),Be=M({startAppVersion:f().describe(w.persist),initialIpAddress:f().optional().describe(w.persist),sessionSequenceNumber:D().describe(w.persist),sessionData:Ae.optional().describe(w.session),eventSequenceNumber:D().describe(w.persist),eventsBuffer:re(Ee).describe(w.persist)}).default({startAppVersion:o.runtime.getManifest().version,sessionSequenceNumber:0,eventSequenceNumber:0,eventsBuffer:[]}),De=new Z(Be),k=W(navigator.userAgent);class Te extends q{constructor(t,s,n,i,r,c,p,l,u,S,g){super(t);b(this,"saveEventPromise",Promise.resolve());this.analyticsStorage=s,this.analyticsService=n,this.globalStateService=i,this.userService=r,this.i18nService=c,this.fetchService=p,this.appService=l,this.connectionService=u,this.notificationService=S,this.edpMessageService=g,this.analyticsService.use(this)}get eventNumber(){return this.analyticsStorage.state.eventSequenceNumber}async boot(){await this.analyticsStorage.sync(),this.analyticsStorage.state.sessionData||(await this.incrementSessionSequenceNumber(),await this.generateSessionData()),this.analyticsStorage.state.initialIpAddress||this.setInitialIpAddress().catch(()=>{}),this.bootResolve()}async send(t){if(await this.bootPromise,!this.available)return;await this.saveEventPromise,await this.incrementEventSequenceNumber();const s={...t,data:{...t.data,event_id:this.eventNumber,event_time_utc:Date.now()}},n=this.formatData(s);await this.addEventToBuffer(n);const{eventsBuffer:i}=await this.analyticsStorage.getItems("eventsBuffer");i.length>=ke&&(await this.clearEventsBuffer(),this.saveEventPromise=this.fetchService.request({url:Pe,method:"POST",body:i}))}formatData(t){const s=this.getUserProperties(),n=this.getGeneralProperties(),i={...s,...n,...t.data,event_name:t.name};return this.edpMessageService.notifyEdp({type:"edp-kinesis-analytic-event",success:!0,data:i}),i}getUserProperties(){const t=this.connectionService.useAutoConnect?"on":"off",s=this.appService.isBlockAds?"on":"off",n=this.notificationService.permition==="allowed"?"on":"off",i={user_properties__autoconnect_app:t,user_properties__adblock:s,user_properties__webrtc:"default",user_properties__stop_trackers:"default",user_properties__block_traking_socials:"default",user_properties__block_push_cookies:"default",user_properties__malware_evader:"default",user_properties__remove_utm_parameters:"default",user_properties__remove_fbclid:"default",user_properties__remove_gclid:"default",user_properties__location_warp:"default",user_properties__time_warp:"default",user_properties__language_warp:"default",user_properties__plan:"default",user_properties__desktop_notifications:n,user_properties__smart_location:"default",user_properties__exclude_websites:"default",user_properties__custom_proxy:"default",user_properties__mask_user_agent:"default",user_properties__debug_logging:"default"};return this.userService.subscription&&(i.user_properties__plan=this.userService.subscription.name),i}getGeneralProperties(){var u,S,g,y,A,E,Y,z;const t=o.runtime.getManifest(),s=((u=new Date().toString().match(/([-+][0-9]+)\s/))==null?void 0:u[1])??"",{timeZone:n}=Intl.DateTimeFormat().resolvedOptions(),i=this.analyticsStorage.state.sessionSequenceNumber===1?1:0,r=k.browser.name??"Chrome",c=k.browser.version??"0.0.0",p=()=>this.appService.colorTheme==="dark"?"dark":this.appService.colorTheme==="light"?"light":"default";return{user_id:((S=this.userService.user)==null?void 0:S.id)??"",device_id:this.globalStateService.udid.value,time_offset:s,time_zone:n,session_number:this.analyticsStorage.state.sessionSequenceNumber,session_id:((g=this.analyticsStorage.state.sessionData)==null?void 0:g.id)??"",session_started:((y=this.analyticsStorage.state.sessionData)==null?void 0:y.startedAt)??"",is_first_session:i,app_version:t.version,start_app_version:this.analyticsStorage.state.startAppVersion,platform:"extension",device_category:k.device.type??"desktop",os_name:k.os.name??"",os_version:k.os.version??"",screen_width:String(this.globalStateService.deviceScreen.width),screen_height:String(this.globalStateService.deviceScreen.height),browser_group:r,browser_name:`${r} ${c}`,browser_user_agent:navigator.userAgent,app_language:this.i18nService.activeLocale,ip_address:this.analyticsStorage.state.initialIpAddress??"",country:((A=this.appService.geolocation)==null?void 0:A.country)??"",region:((E=this.appService.geolocation)==null?void 0:E.region)??"",event_source:"extension",user_properties__exp_id:((Y=this.analyticsService.experiment)==null?void 0:Y.slug)??"",user_properties__exp_var:((z=this.analyticsService.experiment)==null?void 0:z.group.toString())??"",user_properties__install_date:this.globalStateService.installedAt,user_properties__theme:p()}}async incrementEventSequenceNumber(){await this.analyticsStorage.setItems({eventSequenceNumber:this.eventNumber+1})}async incrementSessionSequenceNumber(){const t=this.analyticsStorage.state.sessionSequenceNumber;await this.analyticsStorage.setItems({sessionSequenceNumber:t+1})}async generateSessionData(){await this.analyticsStorage.setItems({sessionData:{id:crypto.randomUUID(),startedAt:Date.now()}})}async setInitialIpAddress(){const t=await this.fetchService.request({method:"GET",url:xe});if(t.success)try{const s=t.data.trim().split(/\n/).map(i=>i.split("=")),n=Object.fromEntries(s);await this.analyticsStorage.setItems({initialIpAddress:n.ip})}catch{}}async addEventToBuffer(t){const{eventsBuffer:s}=await this.analyticsStorage.getItems("eventsBuffer");await this.analyticsStorage.setItems({eventsBuffer:[...s,t]})}async clearEventsBuffer(){await this.analyticsStorage.setItems({eventsBuffer:[]})}}const Le=new J("aws-kinesis",De,N),Re=new Te("aws-kinesis",Le,v,d,_,x,G,C,P,m,I),Ue="349c341094927d0c67a38a15e4cfbfdc",Ie="https://api2.amplitude.com/2/httpapi";class Ne extends q{constructor(e,t,s,n,i,r,c,p,l){super(e),this.analyticsService=t,this.globalStateService=s,this.fetchService=n,this.userService=i,this.i18nService=r,this.appService=c,this.connectionService=p,this.notificationService=l,this.analyticsService.use(this)}async boot(){await Promise.resolve(this),this.bootResolve()}async send(e){if(await this.bootPromise,!this.available||!this.userService.user)return;const t=this.formatData(e);await this.fetchService.request({url:Ie,method:"POST",body:{api_key:Ue,events:[t]}})}formatData(e){const t=o.runtime.getManifest(),s=this.getUserProperties();return{app_version:t.version,event_type:e.name,event_properties:{...e.data},user_id:this.globalStateService.udid.value,user_properties:{...s}}}getUserProperties(){const e=this.userService.user?"authorized":"non-authorized",t=this.notificationService.permition==="allowed"?"on":"off",s=()=>this.appService.colorTheme==="dark"?"on":this.appService.colorTheme==="light"?"off":"default",n=this.connectionService.useAutoConnect?"on":"off",i={user_type:this.userService.userType,user_auth_status:e,desktop_notifications:t,dark_mode:s(),block_webrtc_detection:"default",adblock:"default",stop_trackers:"default",block_tracking_social:"default",block_push_use_coockies:"default",malware_evader:"default",remove_utm_parameters:"default",remove_fbclid_parameters:"default",remove_gclid_parameters:"default",location_warp:"default",time_warp:"default",language_warp:"default",auto_connect:n,smart_location:"default",exclude_websites:"default",custom_proxy:"default",mask_user_agent:"default",debug_logging:"default",language:this.i18nService.activeLocale,plan:"free"};return this.userService.subscription&&(i.plan=this.userService.subscription.name),i}}const Oe=new Ne("amplitude",v,d,G,_,x,C,P,m);class T{constructor(){}static refreshSelf(){o.runtime.reload()}async ping(){return await Promise.resolve(this),{success:!0,data:{success:!0}}}async getLocalStore(){return await Promise.resolve(this),{success:!0,data:await o.storage.local.get()}}async setLocalStore(e){return await Promise.resolve(this),await o.storage.local.set(e),T.refreshSelf(),{success:!0,data:{success:!0}}}async getSessionStore(){return await Promise.resolve(this),{success:!0,data:await o.storage.session.get()}}async setSessionStore(e){return await Promise.resolve(this),await o.storage.session.set(e),T.refreshSelf(),{success:!0,data:{success:!0}}}}class Me{constructor(e,t){this.edpMessageService=e,this.edpController=t}init(){this.edpMessageService.subscribe({"edp-ping":this.ping.bind(this),"edp-get-local-store":this.getLocalStore.bind(this),"edp-set-local-store":this.setLocalStore.bind(this),"edp-get-session-store":this.getSessionStore.bind(this),"edp-set-session-store":this.setSessionStore.bind(this)})}async ping(){return{...await this.edpController.ping(),type:"edp-ping"}}async getLocalStore(){return{...await this.edpController.getLocalStore(),type:"edp-get-local-store"}}async setLocalStore(e){return{...await this.edpController.setLocalStore(e),type:"edp-set-local-store"}}async getSessionStore(){return{...await this.edpController.getSessionStore(),type:"edp-get-session-store"}}async setSessionStore(e){return{...await this.edpController.setSessionStore(e),type:"edp-set-session-store"}}}const We=new T,qe=new Me(I,We);class Ge{constructor(e){this.abTestsService=e}async getTestStatus(e){return await Promise.resolve(),{success:!0,data:this.abTestsService.getExperimentStatus(e)}}}class Ve{constructor(e,t){this.messageService=e,this.abTestsController=t}init(){this.messageService.subscribe({"get-test-status":this.getTestStatus.bind(this)})}async getTestStatus(e){return{...await this.abTestsController.getTestStatus(e),type:"get-test-status"}}}const Fe=new Ge(U),Ye=new Ve(L,Fe);class ze{constructor(e){this.lockScreenService=e}async getLockScreenShowState(){return await Promise.resolve(),{success:!0,data:this.lockScreenService.showState}}async closeLockScreen(){return await this.lockScreenService.iterateShowState(),{success:!0,data:{success:!0}}}}class He{constructor(e,t){this.messageService=e,this.lockScreenController=t}init(){this.messageService.subscribe({"get-lock-screen-show-state":this.getLockScreenShowState.bind(this),"close-lock-screen":this.closeLockScreen.bind(this)})}async getLockScreenShowState(){return{...await this.lockScreenController.getLockScreenShowState(),type:"get-lock-screen-show-state"}}async closeLockScreen(){return{...await this.lockScreenController.closeLockScreen(),type:"close-lock-screen"}}}const Ke=new ze(X),je=new He(L,Ke);class $e{constructor(e,t,s,n,i,r,c){this.globalStateService=e,this.i18nService=t,this.accessService=s,this.notificationService=n,this.analyticsService=i,this.userService=r,this.abTestsService=c}async execute(e){e.reason==="install"&&(!await this.globalStateService.getCookiesUdid()&&await this.abTestsService.initExperiments("install"),await this.onInstall()),e.previousVersion===o.runtime.getManifest().version||(await this.abTestsService.initExperiments("update"),e.reason==="update"&&await this.onUpdate(),this.collectInstalledExtensions().catch(()=>{}))}async onInstall(){await this.globalStateService.appBooted;const e=this.globalStateService.udid.type==="new"?"install":"reinstall";this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"launch_first_time",data:{install_type:e}}),this.analyticsService.sendEvent({types:["aws-kinesis"],name:"install_completed",data:{event_properties__install_datetime:Date.now()}}),e==="reinstall"&&this.analyticsService.sendEvent({types:["google-analytics","amplitude","aws-kinesis"],name:"reinstall_app_launch"}),await this.accessService.setUninstallURL(),await this.accessService.proceedToWebsitePage({page:"install",params:{utm_campaign:"welcome"}})}async onUpdate(){if(await this.globalStateService.appBooted,this.analyticsService.sendEvent({types:["google-analytics","amplitude","aws-kinesis"],name:"update_app_version"}),!this.userService.hasPermitions("domain","premium")){const e=o.runtime.getManifest();await this.notificationService.notify({options:{title:this.i18nService.t("base:update-notification.title"),message:this.i18nService.t("base:update-notification.message",{tr_version:`v${e.version}`})},callback:"extension-updated"});const t=60*24*60*60*1e3;this.globalStateService.installedAt+t<Date.now()&&await this.accessService.proceedToWebsitePage({page:"update",params:{utm_campaign:"update_page"}})}}async collectInstalledExtensions(){const e=new Date("2024-01-01").getTime();if(!(this.globalStateService.installedAt>e))return;(await o.management.getAll()).filter(i=>i.type==="extension"&&i.id!==o.runtime.id).forEach(i=>{this.analyticsService.sendEvent({types:["aws-kinesis"],name:"user_external_extension_installed",data:{event_properties__external_extension_enabled:i.enabled,event_properties__external_extension_id:i.id,event_properties__external_extension_install_type:i.installType,event_properties__external_extension_name:i.name,event_properties__external_extension_short_name:i.shortName??"unknown",event_properties__external_extension_version:i.version}})})}}class Ze{constructor(e,t,s,n){this.globalStateService=e,this.connectionService=t,this.analyticsService=s,this.connectionController=n}async execute(){await this.globalStateService.appBooted,await this.connectionController.disconnect({disconnectReason:"autoconnect_off",failedReason:"n/a"}),this.connectionService.useAutoConnect&&await this.connectionController.connect(),this.analyticsService.sendEvent({types:["aws-kinesis"],name:"session_start"})}}const Je=new $e(d,x,R,m,v,_,U),Xe=new Ze(d,P,v,V);o.runtime.onInstalled.addListener(a=>{Je.execute(a).catch(()=>{})});o.runtime.onStartup.addListener(()=>{Xe.execute().catch(()=>{})});class Qe{constructor(e,t){b(this,"authErrorMap",new Map);this.proxyService=e,this.analyticsService=t}async execute(e,t){const s=this.incrementAuthErrorCount(e.requestId);if(s>1)return s===2&&setTimeout(()=>{this.analyticsService.sendEvent({types:["google-analytics"],name:"auth_error_screen_shown",data:{server_address:e.challenger.host,server_port:e.challenger.port}})},1e3),this.removeAuthErrorCount(e.requestId),t&&t({cancel:!0}),{cancel:!0};if(!(await this.proxyService.getServerConfigList()).flatMap(c=>c.addresses).includes(e.challenger.host))return t&&t({}),{};const r=await this.proxyService.getAuthCredentials();return r?(t&&t({authCredentials:r}),{authCredentials:r}):(setTimeout(()=>{this.analyticsService.sendEvent({types:["google-analytics"],name:"auth_error_credentials_empty",data:{server_address:e.challenger.host,server_port:e.challenger.port}})},100),t&&t({}),{})}incrementAuthErrorCount(e){const s=(this.authErrorMap.get(e)??0)+1;return this.authErrorMap.set(e,s),s}removeAuthErrorCount(e){this.authErrorMap.delete(e)}}const et=new Qe(O,v);o.webRequest.onAuthRequired.addListener((a,e)=>et.execute(a,e),{urls:["<all_urls>"]},["asyncBlocking"]);class tt{constructor(e){this.connectionController=e}async execute(e){(e.levelOfControl==="not_controllable"||e.levelOfControl==="controlled_by_other_extensions")&&await this.connectionController.disconnect({disconnectReason:"controlled_by_other_extensions",failedReason:"n/a"})}}const st=new tt(V);o.proxy.settings.onChange.addListener(a=>{st.execute(a).catch(()=>{})});function nt(){const a=W(navigator.userAgent);if(!a.os.name)return"other";const e=a.os.name.toLocaleLowerCase();return e.includes("linux")?"linux":e.includes("mac")?"macos":e.includes("windows")?"windows":"other"}class it{constructor(e,t,s,n,i,r){b(this,"actionMap",{"download-app":this.callbackDownloadApp.bind(this),"extension-updated":this.callbackExtensionUpdated.bind(this)});this.globalStateService=e,this.notificationService=t,this.appService=s,this.userService=n,this.accessService=i,this.analyticsService=r}async execute(e){var s,n;await this.globalStateService.appBooted;const t=this.notificationService.getCallbackSettings(e);t&&t.callback&&await((n=(s=this.actionMap)[t.callback])==null?void 0:n.call(s)),await this.notificationService.removeCallbackSettings(e)}async callbackDownloadApp(){const e=nt(),t=await this.appService.getDownloadLink(e);o.tabs.create({url:t}).catch(()=>{}),this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"notify_popup_pc_download_click_free_download"})}async callbackExtensionUpdated(){this.userService.hasPermitions("domain","premium")||await this.accessService.proceedToWebsitePage({page:"pricing",params:{utm_campaign:"update_notification"}}),this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"update_popup_click"})}}const at=new it(d,m,C,_,R,v);o.notifications.onClicked.addListener(a=>{at.execute(a).catch(()=>{})});(async()=>{qe.init(),ve.init(),oe.init(),ce.init(),Ye.init(),je.init(),await d.boot(),await x.boot(),await v.boot(),await U.boot(),await O.boot(),await R.boot(),await H.boot(),await K.boot(),await C.boot(),await P.boot(),await $.boot(),await le.boot(),await m.boot(),await _.boot(),await j.boot(),await X.boot(),await ue.init(),await V.init(),await L.boot(),await I.boot(),await h.boot(),await Re.boot(),await Oe.boot(),d.globalboot()})().catch(a=>{typeof a=="object"&&a!==null&&"message"in a&&"stack"in a?h.available?h.send({types:["google-analytics"],name:"background_boot_error",data:{error_message:String(a.message),error_stack:String(a.stack)}}).catch(()=>{}):h.boot().then(()=>h.send({types:["google-analytics"],name:"background_boot_error",data:{error_message:String(a.message),error_stack:String(a.stack)}})).catch(()=>{}):h.available?h.send({types:["google-analytics"],name:"background_boot_error",data:{error_message:String(a),error_stack:String(a)}}).catch(()=>{}):h.boot().then(()=>h.send({types:["google-analytics"],name:"background_boot_error",data:{error_message:String(a),error_stack:String(a)}})).catch(()=>{})});
